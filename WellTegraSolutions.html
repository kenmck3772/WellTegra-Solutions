<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WellTegra Data Solutions: Live Performer Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <!-- 
    Application Evolution: The application's primary focus has shifted from a planning tool to a live operational dashboard. The default view is now the "Performer" view, which simulates a real-time well intervention. This change provides a more dynamic and engaging initial experience. The "Planner" and other modules are still accessible for a complete workflow demonstration.

    UI/UX Enhancements:
    - A new three-column "Performer" view serves as the application's landing page.
    - This view uses a dark theme to create a "control room" aesthetic, enhancing the feeling of a live operational environment.
    - Real-time data is visualized through animated KPIs and a dynamic Chart.js graph that plots planned vs. actual performance.
    - An interactive procedure panel tracks the progress of the operation, and a live log provides updates.
    - An alarm system with visual cues (a pulsing red shadow) alerts the user to off-plan events.
    -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        .main-container::before {
            content: "";
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://storage.googleapis.com/gemini-prod-us-west1-422500-0521/images/eb167572-a346-4b68-8255-b4723b364817');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            opacity: 0.05;
            z-index: -1;
            pointer-events: none;
        }
        .theme-light { background-color: #F8F7F4; color: #1a202c; }
        .theme-dark { background-color: #111827; color: #d1d5db; }
        
        .theme-light .light-card { background-color: white; }
        .theme-dark .light-card { background-color: #1f2937; border: 1px solid #374151; }

        .theme-light .header { background-color: white; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1); }
        .theme-dark .header { background-color: #1f2937; border-bottom: 1px solid #374151; }
        
        .theme-light .nav-link { color: #4b5563; }
        .theme-dark .nav-link { color: #d1d5db; }
        .theme-light .nav-link.active { color: #0d9488; }
        .theme-dark .nav-link.active { color: #2dd4bf; }

        .theme-light h1, .theme-light h2, .theme-light h3, .theme-light h4 { color: #1f2937; }
        .theme-dark h1, .theme-dark h2, .theme-dark h3, .theme-dark h4 { color: #f9fafb; }
        .theme-light p, .theme-light span, .theme-light label, .theme-light td, .theme-light li { color: #4b5563; }
        .theme-dark p, .theme-dark span, .theme-dark label, .theme-dark td, .theme-dark li { color: #d1d5db; }
        
        .theme-light .table-header { background-color: #f3f4f6; }
        .theme-dark .table-header { background-color: #374151; }
        .theme-light .table-row-alt { background-color: #f9fafb; }
        .theme-dark .table-row-alt { background-color: #374151/50; }

        .theme-light .modal-container { background-color: white; }
        .theme-dark .modal-container { background-color: #1f2937; }
        .theme-light .modal-tab { color: #6b7280; }
        .theme-dark .modal-tab { color: #9ca3af; }
        .theme-light .modal-tab.active { color: #0d9488; border-bottom-color: #0d9488; }
        .theme-dark .modal-tab.active { color: #2dd4bf; border-bottom-color: #2dd4bf; }

        .theme-light input, .theme-light textarea { background-color: white; border-color: #d1d5db; color: #111827; }
        .theme-dark input, .theme-dark textarea { background-color: #374151; border-color: #4b5563; color: #f3f4f6; }

        .theme-light .objective-label, .theme-light .problem-label { border-color: #e2e8f0; }
        .theme-dark .objective-label, .theme-dark .problem-label { border-color: #374151; }
        .theme-light input[type="radio"]:checked + .objective-label, .theme-light input[type="radio"]:checked + .problem-label { border-color: #0d9488; background-color: #f0fdfa; }
        .theme-dark input[type="radio"]:checked + .objective-label, .theme-dark input[type="radio"]:checked + .problem-label { border-color: #2dd4bf; background-color: #111827; }

        .theme-light .ai-recommendation-card.selected { border-color: #0d9488; background-color: #f0fdfa; }
        .theme-dark .ai-recommendation-card.selected { border-color: #2dd4bf; background-color: #111827; }
        
        .theme-light .bg-gray-50 { background-color: #f9fafb; }
        .theme-dark .bg-gray-50 { background-color: #374151; }
        
        .theme-light #theme-icon-dark { display: none; }
        .theme-light #theme-icon-light { display: block; }
        .theme-dark #theme-icon-dark { display: block; }
        .theme-dark #theme-icon-light { display: none; }

        .planner-card.selected { border-color: #0d9488; transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .step-indicator { transition: background-color 0.3s, color 0.3s; }
        .step-indicator.active { background-color: #0d9488; color: white; }
        .step-indicator.completed { background-color: #047857; color: white; }
        .risk-low { background-color: #dcfce7; color: #166534; }
        .risk-medium { background-color: #fef9c3; color: #854d0e; }
        .risk-high { background-color: #fee2e2; color: #991b1b; }
        .status-available, .status-active, .status-approved, .status-mustered, .status-passed { background-color: #dcfce7; color: #166534; }
        .status-maintenance, .status-pending, .status-in.transit { background-color: #fef9c3; color: #854d0e; }
        .status-unavailable, .status-on.job, .status-expired, .status-unaccounted, .status-failed { background-color: #fee2e2; color: #991b1b; }
        .status-onboard { background-color: #cffafe; color: #0e7490; }

        /* Performer View Specific Styles */
        .performer-view {
            height: calc(100vh - 70px); /* Full viewport height minus header */
            background-color: #0f172a; /* Dark blue background */
            color: #e2e8f0;
        }
        .performer-view .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 5fr 3fr;
            gap: 1.5rem;
            height: 100%;
        }
        .performer-view .kpi-card {
            background-color: #1e293b; /* Slightly lighter card background */
            border-radius: 0.5rem;
            border: 1px solid #334155;
            transition: all 0.2s ease-in-out;
        }
        .performer-view .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.2);
        }
        .performer-view .procedure-step {
            border-left: 4px solid #4b5563;
            transition: all 0.3s;
        }
        .performer-view .procedure-step.active {
            background-color: rgba(16, 185, 129, 0.1);
            border-left-color: #10b981;
        }
        .performer-view .procedure-step.completed {
            border-left-color: #4b5563;
            opacity: 0.6;
        }
        .performer-view .log-entry {
            border-bottom: 1px solid #334155;
        }
        .performer-view .alarm, .emergency-header {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        
        .nav-link {
            transition: color 0.3s, border-bottom-color 0.3s;
            border-bottom: 2px solid transparent;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
        }
        .nav-link.active {
            color: #0d9488;
        }
        
        .ai-recommendation-card {
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .ai-recommendation-card:hover {
            border-color: #0d9488;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }
        .ai-recommendation-card.selected {
            border-width: 2px;
            border-color: #0d9488;
            background-color: #f0fdfa;
        }
        
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-container { transition: transform 0.3s ease; }
        .schematic-label, .table-text { font-family: 'Roboto Mono', monospace; font-size: 10px; }
        .schematic-label { fill: #4b5563; }
        .schematic-depth-marker { font-size: 9px; font-family: 'Roboto Mono', monospace; fill: #1d4ed8; }
        .table-header { background-color: #e5e7eb; font-weight: 600; }
        .modal-tab { border-bottom: 2px solid transparent; }
        .modal-tab.active { border-bottom-color: #0d9488; color: #0d9488; }
    </style>
</head>
<body class="theme-dark">

    <div id="app-container" class="min-h-screen flex flex-col main-container">
        <header id="app-header" class="header sticky top-0 z-10 transition-colors">
            <div class="max-w-full mx-auto py-3 px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <img src="https://storage.googleapis.com/gemini-prod-us-west1-422500-0521/images/eb167572-a346-4b68-8255-b4723b364817" alt="WellTegra Data Solutions Logo" class="h-10 w-auto mr-3 rounded-full">
                        <h1 id="header-title" class="text-xl font-bold">WellTegra Data Solutions</h1>
                    </div>
                    <div id="header-nav" class="flex items-center space-x-2">
                        <a id="performer-nav-link" class="nav-link active">Performer</a>
                        <a id="planner-nav-link" class="nav-link">Planner</a>
                        <a id="logistics-nav-link" class="nav-link">Logistics</a>
                        <a id="commercial-nav-link" class="nav-link">Commercial</a>
                        <a id="hse-nav-link" class="nav-link">HSE & Risk</a>
                        <a id="pob-nav-link" class="nav-link">POB & ER</a>
                        <a id="analyzer-nav-link" class="nav-link">Analyzer</a>
                    </div>
                    <div id="header-details" class="flex items-center space-x-4">
                        <!-- Dynamic content will be injected here -->
                    </div>
                    <button id="theme-toggle-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                        <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                        <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                    </button>
                </div>
            </div>
        </header>

        <main id="main-content" class="flex-1">
            <div id="performer-view" class="view-container performer-view p-4 lg:p-6 h-full">
                <div class="h-full dashboard-grid">
                    <!-- Left Panel: Procedure -->
                    <div id="procedure-panel" class="bg-slate-800/50 rounded-lg p-4 flex flex-col">
                        <h2 class="text-lg font-semibold mb-4 border-b border-slate-700 pb-2">Operational Procedure</h2>
                        <div id="procedure-steps" class="flex-1 space-y-3 overflow-y-auto pr-2">
                            <!-- JS will populate this -->
                        </div>
                        <div id="performer-controls" class="hidden mt-4">
                             <button id="view-analysis-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-md transition-transform duration-200 hover:scale-105">View Post-Job Analysis</button>
                        </div>
                    </div>

                    <!-- Center Panel: KPIs, Chart, Controls -->
                    <div class="flex flex-col gap-4 lg:gap-6">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 lg:gap-6">
                            <div class="kpi-card p-4"><p class="text-sm text-slate-400">Hookload (klbf)</p><p id="kpi-hookload" class="text-3xl font-bold">0.0</p></div>
                            <div class="kpi-card p-4"><p class="text-sm text-slate-400">Pump Pressure (psi)</p><p id="kpi-pressure" class="text-3xl font-bold">0</p></div>
                            <div class="kpi-card p-4"><p class="text-sm text-slate-400">CT Speed (ft/min)</p><p id="kpi-speed" class="text-3xl font-bold">0</p></div>
                            <div class="kpi-card p-4"><p class="text-sm text-slate-400">Depth (ft)</p><p id="kpi-depth" class="text-3xl font-bold">0</p></div>
                        </div>
                        <div id="chart-card" class="flex-1 bg-slate-800/50 rounded-lg p-4 flex flex-col">
                            <h3 class="text-lg font-semibold mb-2">Tubing Force Analysis: Plan vs. Actual</h3>
                            <div class="flex-1 relative">
                                <canvas id="tfaChart"></canvas>
                            </div>
                        </div>
                        <div id="manual-controls" class="bg-slate-800/50 rounded-lg p-4 flex items-center justify-center space-x-4">
                            <button id="step-backward-btn" class="rounded-md bg-slate-600 px-6 py-2 text-base font-semibold text-white shadow-sm hover:bg-slate-500 disabled:opacity-50" disabled>Step Back</button>
                            <button id="step-forward-btn" class="rounded-md bg-teal-600 px-6 py-2 text-base font-semibold text-white shadow-sm hover:bg-teal-500">Step Forward</button>
                        </div>
                    </div>

                    <!-- Right Panel: Log -->
                    <div class="bg-slate-800/50 rounded-lg p-4 flex flex-col">
                        <h2 class="text-lg font-semibold mb-4 border-b border-slate-700 pb-2">Operations Log</h2>
                        <div id="log-entries" class="flex-1 space-y-3 overflow-y-auto mb-4 pr-2">
                            <!-- JS will populate this -->
                        </div>
                        <div class="mt-auto">
                            <textarea id="log-input" class="w-full bg-slate-900 border border-slate-600 rounded-md p-2 text-sm" rows="3" placeholder="Add log entry..."></textarea>
                            <button id="add-log-btn" class="mt-2 w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2 px-4 rounded-md transition-transform duration-200 hover:scale-105">Add Entry</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="planner-view" class="hidden max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
                <div class="mb-12 flex items-center justify-center space-x-4">
                    <div id="step-1-indicator" class="step-indicator active w-10 h-10 rounded-full flex items-center justify-center font-bold">1</div>
                    <div class="flex-1 h-1 bg-gray-200 rounded-full"></div>
                    <div id="step-2-indicator" class="step-indicator bg-gray-200 text-gray-500 w-10 h-10 rounded-full flex items-center justify-center font-bold">2</div>
                    <div class="flex-1 h-1 bg-gray-200 rounded-full"></div>
                    <div id="step-3-indicator" class="step-indicator bg-gray-200 text-gray-500 w-10 h-10 rounded-full flex items-center justify-center font-bold">3</div>
                </div>
                <section id="step-1"><div class="text-center"><h2 class="text-3xl font-bold tracking-tight">Step 1: Select a Well</h2><p class="mt-2 max-w-2xl mx-auto text-lg">Choose a candidate well for the intervention plan.</p></div><div id="well-selection-grid" class="mt-10 grid gap-8 md:grid-cols-2 lg:grid-cols-3"></div></section>
                <section id="step-2" class="hidden">
                    <div class="text-center"><h2 class="text-3xl font-bold tracking-tight">Step 2: Define Intervention Plan</h2><p class="mt-2 max-w-2xl mx-auto text-lg">Choose a planning method to define the primary goal for this intervention.</p></div>
                    <div class="mt-8 max-w-4xl mx-auto">
                        <div class="flex items-center justify-center mb-6">
                            <span class="text-sm font-medium mr-3">Manual Planning</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="ai-toggle" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-2 peer-focus:ring-teal-300 dark:peer-focus:ring-teal-800 dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-teal-600"></div>
                            </label>
                            <span class="text-sm font-medium ml-3">AI Advisor</span>
                        </div>
                        <div id="manual-planning-view">
                            <fieldset id="objectives-fieldset" class="space-y-4"></fieldset>
                            <div class="mt-8 flex justify-center"><button id="generate-plan-btn-manual" class="rounded-md bg-teal-600 px-6 py-3 text-base font-semibold text-white shadow-sm hover:bg-teal-500 disabled:bg-gray-400" disabled>Generate Plan</button></div>
                        </div>
                        <div id="ai-advisor-view" class="hidden">
                            <div id="problem-selection"><h3 class="text-lg font-semibold text-center mb-4">What is the primary problem with this well?</h3><fieldset id="problems-fieldset" class="space-y-4"></fieldset></div>
                            <div id="ai-recommendations" class="hidden mt-8"></div>
                            <div class="mt-8 flex justify-center"><button id="generate-plan-btn-ai" class="rounded-md bg-teal-600 px-6 py-3 text-base font-semibold text-white shadow-sm hover:bg-teal-500 disabled:bg-gray-400" disabled>Generate Plan from Recommendation</button></div>
                        </div>
                    </div>
                </section>
                <section id="step-3" class="hidden"><div class="text-center"><h2 class="text-3xl font-bold tracking-tight">Step 3: Review the Generated Plan</h2><p class="mt-2 max-w-2xl mx-auto text-lg">This is the initial, data-driven plan. Review and then begin the live operation.</p></div><div id="plan-output" class="mt-10 light-card p-6 md:p-8 space-y-8"></div><div class="mt-8 flex justify-center space-x-4"><button id="start-over-btn" class="rounded-md bg-gray-600 px-6 py-3 text-base font-semibold text-white shadow-sm hover:bg-gray-500">Start Over</button><button id="begin-op-btn" class="rounded-md bg-emerald-600 px-6 py-3 text-base font-semibold text-white shadow-sm hover:bg-emerald-500">Begin Live Operation</button></div></section>
            </div>

            <div id="logistics-view" class="hidden max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
                <div class="text-center"><h2 class="text-3xl font-bold tracking-tight">Logistics & Asset Management</h2><p class="mt-2 max-w-2xl mx-auto text-lg">Manage equipment and personnel availability, certifications, and maintenance schedules.</p></div>
                <div class="mt-10 grid gap-12 lg:grid-cols-2">
                    <div class="light-card p-6"><h3 class="text-xl font-semibold mb-4">Equipment Hub</h3><input type="text" id="equipment-search" placeholder="Search equipment..." class="w-full p-2 border border-gray-300 rounded-md mb-4"><div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="table-header"><tr><th class="p-2">Asset ID</th><th>Type</th><th>Location</th><th>Test Status</th><th>Actions</th></tr></thead><tbody id="equipment-table-body"></tbody></table></div></div>
                    <div class="light-card p-6"><h3 class="text-xl font-semibold mb-4">Personnel Roster</h3><input type="text" id="personnel-search" placeholder="Search personnel..." class="w-full p-2 border border-gray-300 rounded-md mb-4"><div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="table-header"><tr><th class="p-2">Name</th><th>Role</th><th>Status</th><th>Certs Valid</th></tr></thead><tbody id="personnel-table-body"></tbody></table></div></div>
                </div>
            </div>
            
            <div id="commercial-view" class="hidden max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
                 <div class="text-center"><h2 class="text-3xl font-bold tracking-tight">Commercial Dashboard</h2><p id="commercial-subtitle" class="mt-2 max-w-2xl mx-auto text-lg">Live financial tracking for the selected operation.</p></div>
                 <div id="commercial-content" class="mt-10"></div>
            </div>

            <div id="hse-view" class="hidden max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
                 <div class="text-center"><h2 class="text-3xl font-bold tracking-tight">HSE & Risk Dashboard</h2><p id="hse-subtitle" class="mt-2 max-w-2xl mx-auto text-lg">Centralized risk register and permit to work status.</p></div>
                 <div id="hse-content" class="mt-10"></div>
            </div>

            <div id="pob-view" class="hidden max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
                 <div class="text-center"><h2 class="text-3xl font-bold tracking-tight">Personnel on Board & Emergency Response</h2><p id="pob-subtitle" class="mt-2 max-w-2xl mx-auto text-lg">Live POB manifest and emergency muster status.</p></div>
                 <div id="pob-content" class="mt-10"></div>
            </div>

            <div id="analyzer-view" class="hidden max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
                <div class="text-center"><h2 class="text-3xl font-bold tracking-tight">Post-Job Analysis</h2><p id="analyzer-subtitle" class="mt-2 max-w-2xl mx-auto text-lg"></p></div>
                <div class="mt-10 grid gap-8 lg:grid-cols-2"><div class="light-card p-6 md:p-8"><h3 class="text-xl font-semibold mb-4">Performance Summary</h3><div id="summary-kpis" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div></div><div class="light-card p-6 md:p-8"><h3 class="text-xl font-semibold mb-4">Non-Productive Time (NPT) Breakdown</h3><div class="h-64 md:h-80"><canvas id="nptChart"></canvas></div></div></div>
                <div class="mt-8 light-card p-6 md:p-8"><h3 class="text-xl font-semibold mb-4">Lessons Learned</h3><div id="lessons-learned-list" class="space-y-4 mb-6"></div><div><textarea id="lesson-input" class="w-full border border-gray-300 rounded-md p-2 text-base" rows="3" placeholder="Add a new lesson learned..."></textarea><button id="add-lesson-btn" class="mt-2 rounded-md bg-teal-600 px-4 py-2 text-base font-semibold text-white shadow-sm hover:bg-teal-500">Add Lesson</button></div></div>
                <div class="mt-8 flex justify-center"><button id="plan-new-job-btn" class="rounded-md bg-gray-600 px-6 py-3 text-base font-semibold text-white shadow-sm hover:bg-gray-500">Plan New Job</button></div>
            </div>
            
        </main>
        
        <div id="well-history-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 modal-overlay">
            <div class="relative top-10 mx-auto p-5 border w-full max-w-5xl shadow-lg rounded-md modal-container">
                <div class="flex justify-between items-center border-b pb-3">
                    <h3 id="modal-title" class="text-2xl font-bold"></h3>
                    <button id="close-modal-btn" class="text-3xl font-bold">&times;</button>
                </div>
                <div id="modal-content" class="mt-4 max-h-[80vh] overflow-y-auto p-1"></div>
            </div>
        </div>

    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- DATA STORE ---
        let wellData = [
            { id: 'W001', name: 'Gullfaks C-34', field: 'Gullfaks', region: 'Norwegian Sector', type: 'Oil Producer', depth: '2,850m', status: 'Active - Underperforming', issue: 'Suspected scale buildup in tubing.', history: [ { date: '2022-05-12', operation: 'Slickline Plug Set', problem: 'Minor delays due to weather.', lesson: 'Allocate more buffer time for weather in North Sea operations during spring.' }, { date: '2020-10-03', operation: 'Scale Inhibitor Squeeze', problem: 'Pump failure led to 12 hours of NPT.', lesson: 'Increase preventative maintenance frequency on pump units.' } ], dailyReports: [ { date: '2022-05-12', summary: 'RIH to set plug. Encountered minor weather delays.', npt: 2.5 }, { date: '2022-05-13', summary: 'Set plug successfully. POOH. Job complete.', npt: 0 } ], completion: { casing: [{type: 'Surface', size: '13 3/8', top: 0, bottom: 800}, {type: 'Production', size: '9 5/8', top: 0, bottom: 2850}], tubing: [{type: 'Production', size: '4 1/2', top: 0, bottom: 2750}], equipment: [{item: 'SSSV', top: 1200, comments: 'TRSSSV, Flapper'}, {item: 'Packer', top: 2700, comments: 'Hydraulic Set'}, {item: 'Scale Buildup', top: 2300, comments: 'Suspected from history', isProblem: true}], perforations: [{top: 2800, bottom: 2820, date: '2019-03-10'}] } },
            { id: 'W002', name: 'Statfjord A-12', field: 'Statfjord', region: 'Norwegian Sector', type: 'Water Injector', depth: '3,100m', status: 'Active - Low Injectivity', issue: 'Possible perforation plugging.', history: [ { date: '2023-01-20', operation: 'Coiled Tubing Acid Wash', problem: 'Incorrect acid concentration mixed initially.', lesson: 'Implement double-check verification for all fluid mixtures.' } ], dailyReports: [ { date: '2023-01-20', summary: 'Rig up CTU. Mixed acid, identified concentration error. Remixed. NPT: 3 hours.', npt: 3 }, { date: '2023-01-21', summary: 'RIH, spotted acid. POOH. Job complete.', npt: 0 } ], completion: { casing: [{type: 'Production', size: '9 5/8', top: 0, bottom: 3100}], tubing: [{type: 'Injection', size: '4 1/2', top: 0, bottom: 3000}], equipment: [{item: 'Packer', top: 2950, comments: 'Hydraulic Set'}], perforations: [{top: 3050, bottom: 3080, date: '2017-05-20', comments: 'Partially plugged', isProblem: true}] } },
            { id: 'W003', name: 'Oseberg B-21', field: 'Oseberg', region: 'Norwegian Sector', type: 'Gas Producer', depth: '2,500m', status: 'Shut-in', issue: 'Suspected downhole safety valve failure.', history: [ { date: '2021-08-05', operation: 'Routine DHSV Test', problem: 'Valve failed to close on first attempt.', lesson: 'DHSV shows early signs of wear; schedule for replacement in next planned intervention.' } ], dailyReports: [ { date: '2021-08-05', summary: 'Performed routine DHSV test. Valve failed initial closure command. Cycled valve multiple times, eventually closed. Recommend monitoring.', npt: 1.5 } ], completion: { casing: [{type: 'Production', size: '7', top: 0, bottom: 2500}], tubing: [{type: 'Production', size: '3 1/2', top: 0, bottom: 2400}], equipment: [{item: 'SSSV', top: 1000, comments: 'Failed to close on test', isProblem: true}, {item: 'Packer', top: 2350, comments: 'Mechanical Set'}], perforations: [{top: 2450, bottom: 2480, date: '2018-01-15'}] } },
            { id: 'W004', name: 'Halfdan D-5', field: 'Halfdan', region: 'Danish Sector', type: 'Oil Producer', depth: '2,200m', status: 'P&A Candidate', issue: 'High water cut; uneconomical production.', history: [ { date: '2022-09-18', operation: 'Zonal Isolation Evaluation', problem: 'Logging tool failure downhole (NPT event).', lesson: 'Ensure all electronic tools are surface-tested for 4 hours prior to RIH.' } ], dailyReports: [], completion: { casing: [{type: 'Surface', size: '13 3/8', top: 0, bottom: 500}, {type: 'Production', size: '9 5/8', top: 0, bottom: 2200}], plugs: [{type: 'Surface Plug', top: 50, bottom: 100, material: 'Cement'}, {type: 'Intermediate Plug', top: 1200, bottom: 1300, material: 'Cement'}, {type: 'Reservoir Plug', top: 2100, bottom: 2200, material: 'Cement'}] } },
        ];
        const objectivesData = [ { id: 'obj1', name: 'Production Enhancement', description: 'Intervention to increase hydrocarbon flow rate.' }, { id: 'obj2', name: 'Water Shut-off', description: 'Isolate water-producing zones to reduce water cut.' }, { id: 'obj3', name: 'Well Integrity Restoration', description: 'Repair or replace failed downhole components.' }, { id: 'obj4', name: 'Plug & Abandonment', description: 'Permanently seal the wellbore.' }, ];
        const problemsData = [ { id: 'prob1', name: 'Production Decline / Low Injectivity', description: 'Well performance is below expected levels.', linked_objectives: ['obj1'] }, { id: 'prob2', name: 'Well Integrity Concern', description: 'Suspected failure of a downhole component (e.g., DHSV, packer).', linked_objectives: ['obj3'] }, { id: 'prob3', name: 'End of Life / Uneconomical', description: 'Well is no longer commercially viable.', linked_objectives: ['obj4', 'obj2'] }, ];
        const aiRecommendations = {
            prob1: [ { objectiveId: 'obj1', confidence: 92, outcome: '+250 bopd uplift', reason: 'Offset well analysis shows high success rate for acid stimulation in this formation.' } ],
            prob2: [ { objectiveId: 'obj3', confidence: 88, outcome: 'Restore well to safe operational state', reason: 'Log data indicates likely DHSV failure, a standard slickline operation.' }, { objectiveId: 'obj4', confidence: 65, outcome: 'Permanently secure well', reason: 'P&A is a secondary option if integrity restoration is not feasible or economical.' } ],
            prob3: [ { objectiveId: 'obj4', confidence: 95, outcome: 'Well permanently abandoned per regulations', reason: 'Well is a clear P&A candidate based on economic limit test.' }, { objectiveId: 'obj2', confidence: 55, outcome: 'Reduce water cut by 40%', reason: 'Water shut-off may extend well life, but has lower confidence of economic success.' } ]
        };
        const proceduresData = {
            obj1: { name: "Coiled Tubing Acid Stimulation", personnel: ["Coiled Tubing Supervisor", "Pump Operator", "Wellsite Engineer"], steps: ["Hold pre-job safety meeting & TBT.", "Confirm all PTW are approved.", "Rig up Coiled Tubing unit and PCE.", "Pressure test PCE to 5000 psi.", "Run in hole (RIH) to 9,500 ft.", "Spot 50 bbls of 15% HCl acid.", "Pull out of hole (POOH) to surface.", "Flow back well and monitor returns.", "Rig down equipment."], tooling: ["Coiled Tubing Unit", "High-Pressure Pumps", "Fluid Tanks", "Jetting Nozzle BHA", "Wellhead Pressure Control Equipment", "Data Acquisition System"], risks: { operational: 4, geological: 3, equipment: 3, hse: 4, financial: 2 }, cost: 750000, duration: 5, tfaModel: { pickUp: [[0,0], [9500, 25]], slackOff: [[0,0], [9500, -25]], alarmUpper: [[0,2], [9500, 27]], alarmLower: [[0,-2], [9500, -27]] } },
            obj2: { name: "Mechanical Plug Installation", personnel: ["Wireline Supervisor", "Wireline Operator"], steps: ["Hold pre-job safety meeting & TBT.", "Confirm all PTW are approved.", "Rig up Wireline unit.", "Run in hole with gauge ring.", "Run in hole with bridge plug and set at target depth.", "Dump bail cement on top of plug.", "Pressure test to confirm seal.", "Rig down equipment."], tooling: ["Wireline Truck/Skid", "Pressure Control Equipment (Lubricator)", "Setting Tool for Bridge Plug", "Gauge Rings", "Dump Bailer"], risks: { operational: 3, geological: 2, equipment: 3, hse: 3, financial: 1 }, cost: 325000, duration: 3, tfaModel: { pickUp: [[0,0], [9500, 10]], slackOff: [[0,0], [9500, -10]], alarmUpper: [[0,1], [9500, 11]], alarmLower: [[0,-1], [9500, -11]] } },
            obj3: { name: "DHSV Replacement via Slickline", personnel: ["Slickline Supervisor", "Slickline Operator"], steps: ["Hold pre-job safety meeting & TBT.", "Confirm all PTW are approved.", "Rig up Slickline unit.", "Run in hole to equalize and retrieve failed DHSV insert.", "Run in hole with new DHSV insert and lock into place.", "Pressure test control line and valve.", "Function test valve.", "Rig down equipment."], tooling: ["Slickline Unit", "DHSV Pulling/Running Tools", "Hydraulic Control Unit for DHSV"], risks: { operational: 4, geological: 1, equipment: 5, hse: 4, financial: 3 }, cost: 480000, duration: 5, tfaModel: { pickUp: [[0,0], [9500, 5]], slackOff: [[0,0], [9500, -5]], alarmUpper: [[0,1], [9500, 6]], alarmLower: [[0,-1], [9500, -6]] } },
            obj4: { name: "P&A - Section Milling & Plugging", personnel: ["Rig Supervisor", "Driller", "Derrickhand", "Floorhand"], steps: ["Hold pre-job safety meeting & TBT.", "Confirm all PTW are approved.", "Rig up workover rig.", "Mill section of casing to expose formation.", "Set balanced cement plug across milled section.", "Verify plug placement and integrity.", "Repeat for all required barriers.", "Rig down equipment."], tooling: ["Workover Rig", "Milling BHA (Motor & Mill)", "Cementing Unit", "Casing Scrapers & Brushes"], risks: { operational: 5, geological: 4, equipment: 4, hse: 5, financial: 4 }, cost: 2500000, duration: 18, tfaModel: { pickUp: [[0,0], [5000, 50]], slackOff: [[0,0], [5000, -50]], alarmUpper: [[0,10], [5000, 60]], alarmLower: [[0,-10], [5000, -60]] } }
        };
        let equipmentData = [ { id: 'CTU-01', type: 'Coiled Tubing Unit', location: 'Onboard - Deck A', testStatus: 'Passed', nextMaint: '2025-09-15', rate: 25000 }, { id: 'CTU-02', type: 'Coiled Tubing Unit', location: 'Onshore Base', testStatus: 'Pending', nextMaint: '2025-07-10', rate: 25000 }, { id: 'WL-01', type: 'Wireline Truck/Skid', location: 'Onshore Base', testStatus: 'N/A', nextMaint: '2025-08-22', rate: 18000 }, { id: 'SL-01', type: 'Slickline Unit', location: 'In Transit', testStatus: 'Pending', nextMaint: '2025-07-20', rate: 15000 }, { id: 'PUMP-01', type: 'High-Pressure Pumps', location: 'Onboard - Pump Room', testStatus: 'Pending', nextMaint: '2025-10-01', rate: 8000 }, { id: 'PUMP-02', type: 'High-Pressure Pumps', location: 'Available', testStatus: 'N/A', nextMaint: '2025-11-05', rate: 8000 }, { id: 'RIG-01', type: 'Workover Rig', location: 'Onboard - Drill Floor', testStatus: 'Passed', nextMaint: '2025-08-01', rate: 85000 }, ];
        let personnelData = [ { id: 'P001', name: 'Bob Raker', role: 'Wellsite Engineer', company: 'Operator', status: 'Onboard', certsValid: true, rate: 2200, muster: 'A', lifeboat: 1 }, { id: 'P002', name: 'Jane Smith', role: 'Coiled Tubing Supervisor', company: 'Service Co.', status: 'Onboard', certsValid: true, rate: 2500, muster: 'A', lifeboat: 1 }, { id: 'P003', name: 'Mike Johnson', role: 'Wireline Supervisor', company: 'Service Co.', status: 'On Job', certsValid: true, rate: 2300, muster: 'B', lifeboat: 2 }, { id: 'P004', name: 'Emily White', role: 'Slickline Supervisor', company: 'Service Co.', status: 'Available', certsValid: false, rate: 2300, muster: 'B', lifeboat: 2 }, { id: 'P005', name: 'Chris Green', role: 'Pump Operator', company: 'Service Co.', status: 'In Transit', certsValid: true, rate: 1800, muster: 'A', lifeboat: 1 }, { id: 'P006', name: 'Alex Brown', role: 'Rig Supervisor', company: 'Operator', status: 'Onboard', certsValid: true, rate: 3000, muster: 'B', lifeboat: 2 }, ];
        const musterStations = [ { id: 'A', name: 'Muster Station A', capacity: 50, current: 0 }, { id: 'B', name: 'Muster Station B', capacity: 50, current: 0 } ];
        const safetyData = { 
            meetings: [ { "Meeting_ID": "SM-1", "Date": "2025-05-12", "Topic": "Safe Handling of Slickline Tools", "Attendees": 12, "Key_Discussion": "Discussed Safe Handling of Slickline Tools. Reviewed Job Safety Analysis (JSA) for safe operations. Emphasized proper PPE usage and emergency response protocols. Action items: Conduct follow-up training.", "Action_Items": "Schedule additional training; verify equipment guards." }, { "Meeting_ID": "SM-2", "Date": "2025-01-20", "Topic": "Coiled Tubing Pressure Control Procedures", "Attendees": 8, "Key_Discussion": "Discussed Coiled Tubing Pressure Control Procedures. Reviewed Job Safety Analysis (JSA) for safe operations. Emphasized proper PPE usage and emergency response protocols. Action items: Conduct follow-up training.", "Action_Items": "Schedule additional training; verify equipment guards." }, { "Meeting_ID": "SM-3", "Date": "2025-03-30", "Topic": "E-Line Cable Management and Electrical Safety", "Attendees": 11, "Key_Discussion": "Discussed E-Line Cable Management and Electrical Safety. Reviewed Job Safety Analysis (JSA) for safe operations. Emphasized proper PPE usage and emergency response protocols. Action items: Conduct follow-up training.", "Action_Items": "Schedule additional training; verify equipment guards." } ],
            talks: [ { "Talk_ID": "TB-1", "Date": "2025-06-28", "Topic": "Slickline Tool Deployment Safety", "Key_Points": "Focused on Slickline Tool Deployment Safety. Highlighted importance of checking equipment guards and maintaining situational awareness. Discussed OSHA guidelines for struck-by/caught-between hazards.", "Presenter": "Bob Raker", "Duration_Minutes": 6 }, { "Talk_ID": "TB-2", "Date": "2025-02-12", "Topic": "Coiled Tubing Circulation Hazards", "Key_Points": "Focused on Coiled Tubing Circulation Hazards. Highlighted importance of checking equipment guards and maintaining situational awareness. Discussed OSHA guidelines for struck-by/caught-between hazards.", "Presenter": "Mike Johnson", "Duration_Minutes": 14 }, { "Talk_ID": "TB-3", "Date": "2025-04-05", "Topic": "E-Line Electrical Shock Prevention", "Key_Points": "Focused on E-Line Electrical Shock Prevention. Highlighted importance of checking equipment guards and maintaining situational awareness. Discussed OSHA guidelines for struck-by/caught-between hazards.", "Presenter": "Jane Smith", "Duration_Minutes": 13 } ],
            incidents: [ { "Incident_ID": "IR-1", "Date": "2025-04-18", "Type": "Struck-By/Caught-Between", "Description": "Incident involving Struck-By/Caught-Between during slickline operations. No injuries reported. Root cause: inadequate equipment securing.", "Location": "Platform A", "Corrective_Action": "Enhanced JSA training; implemented stricter equipment checks." }, { "Incident_ID": "IR-2", "Date": "2025-03-09", "Type": "Pressure System Failure", "Description": "Incident involving Pressure System Failure during coiled tubing operations. No injuries reported. Root cause: inadequate equipment securing.", "Location": "Vessel C", "Corrective_Action": "Enhanced JSA training; implemented stricter equipment checks." }, { "Incident_ID": "IR-3", "Date": "2025-06-02", "Type": "Near Miss - Falling Object", "Description": "Incident involving Electrical Shock during e-line operations. No injuries reported. Root cause: inadequate equipment securing.", "Location": "Platform B", "Corrective_Action": "Enhanced JSA training; implemented stricter equipment checks." } ],
            stopCards: [ { "Card_ID": "SC-1", "Date": "2025-02-22", "Hazard": "Unsecured slickline tool detected", "Description": "Stop card issued for Unsecured slickline tool detected. Work paused to address hazard. Action taken: Secured equipment and conducted safety review.", "Reported_By": "Worker B" }, { "Card_ID": "SC-2", "Date": "2025-05-15", "Hazard": "Coiled tubing pressure anomaly", "Description": "Stop card issued for Coiled tubing pressure anomaly. Work paused to address hazard. Action taken: Secured equipment and conducted safety review.", "Reported_By": "Worker A" }, { "Card_ID": "SC-3", "Date": "2025-03-21", "Hazard": "Potential H2S exposure", "Description": "Stop card issued for E-line cable insulation damage. Work paused to address hazard. Action taken: Secured equipment and conducted safety review.", "Reported_By": "Supervisor C" } ]
        };
        const permitTemplates = {
            'Coiled Tubing Acid Stimulation': [{ id: 'PTW001', name: 'General Permit to Work', required: true }, { id: 'PTW004', name: 'Chemical Handling Permit', required: true }, { id: 'PTW005', name: 'Pressure Systems Integrity', required: true }],
            'Mechanical Plug Installation': [{ id: 'PTW001', name: 'General Permit to Work', required: true }, { id: 'PTW006', name: 'Work Over Water Permit', required: true }],
            'DHSV Replacement via Slickline': [{ id: 'PTW001', name: 'General Permit to Work', required: true }, { id: 'PTW005', name: 'Pressure Systems Integrity', required: true }],
            'P&A - Section Milling & Plugging': [{ id: 'PTW001', name: 'General Permit to Work', required: true }, { id: 'PTW002', name: 'Hot Work Permit', required: true }]
        };

        // --- GLOBAL STATE ---
        let appState = {
            currentView: 'performer', selectedWell: null, selectedObjective: null, generatedPlan: null, liveData: null, logEntries: [], lessonsLearned: [], tfaChartInstance: null, nptChartInstance: null, simulationInterval: null,
            commercial: { afe: 0, actualCost: 0, serviceTickets: [] },
            ai: { selectedProblemId: null, selectedRecommendation: null },
            hse: { permits: [], riskRegister: [] },
            pob: { musterActive: false, musterInterval: null, personnel: [] }
        };

        // --- DOM ELEMENTS ---
        const body = document.body, appHeader = document.getElementById('app-header'), headerTitle = document.getElementById('header-title'), headerDetails = document.getElementById('header-details'), headerNav = document.getElementById('header-nav');
        const plannerView = document.getElementById('planner-view'), performerView = document.getElementById('performer-view'), analyzerView = document.getElementById('analyzer-view'), logisticsView = document.getElementById('logistics-view'), commercialView = document.getElementById('commercial-view'), hseView = document.getElementById('hse-view'), pobView = document.getElementById('pob-view');
        const stepIndicators = { 1: document.getElementById('step-1-indicator'), 2: document.getElementById('step-2-indicator'), 3: document.getElementById('step-3-indicator') };
        const step1Section = document.getElementById('step-1'), step2Section = document.getElementById('step-2'), step3Section = document.getElementById('step-3');
        const wellSelectionGrid = document.getElementById('well-selection-grid'), objectivesFieldset = document.getElementById('objectives-fieldset'), generatePlanBtnManual = document.getElementById('generate-plan-btn-manual'), generatePlanBtnAi = document.getElementById('generate-plan-btn-ai');
        const planOutput = document.getElementById('plan-output'), startOverBtn = document.getElementById('start-over-btn'), beginOpBtn = document.getElementById('begin-op-btn');
        const kpiHookload = document.getElementById('kpi-hookload'), kpiPressure = document.getElementById('kpi-pressure'), kpiSpeed = document.getElementById('kpi-speed'), kpiDepth = document.getElementById('kpi-depth');
        const procedureStepsContainer = document.getElementById('procedure-steps'), logEntriesContainer = document.getElementById('log-entries'), logInput = document.getElementById('log-input'), addLogBtn = document.getElementById('add-log-btn');
        const chartCard = document.getElementById('chart-card'), performerControls = document.getElementById('performer-controls'), viewAnalysisBtn = document.getElementById('view-analysis-btn');
        const stepForwardBtn = document.getElementById('step-forward-btn'), stepBackwardBtn = document.getElementById('step-backward-btn');
        const analyzerSubtitle = document.getElementById('analyzer-subtitle'), summaryKpis = document.getElementById('summary-kpis'), lessonsLearnedList = document.getElementById('lessons-learned-list'), lessonInput = document.getElementById('lesson-input'), addLessonBtn = document.getElementById('add-lesson-btn'), planNewJobBtn = document.getElementById('plan-new-job-btn');
        const equipmentTableBody = document.getElementById('equipment-table-body'), personnelTableBody = document.getElementById('personnel-table-body');
        const equipmentSearch = document.getElementById('equipment-search'), personnelSearch = document.getElementById('personnel-search');
        const commercialContent = document.getElementById('commercial-content'), commercialSubtitle = document.getElementById('commercial-subtitle');
        const aiToggle = document.getElementById('ai-toggle'), manualPlanningView = document.getElementById('manual-planning-view'), aiAdvisorView = document.getElementById('ai-advisor-view');
        const problemsFieldset = document.getElementById('problems-fieldset'), aiRecommendationsContainer = document.getElementById('ai-recommendations');
        const modal = document.getElementById('well-history-modal'), modalTitle = document.getElementById('modal-title'), modalContent = document.getElementById('modal-content'), closeModalBtn = document.getElementById('close-modal-btn');
        const hseContent = document.getElementById('hse-content'), hseSubtitle = document.getElementById('hse-subtitle');
        const pobContent = document.getElementById('pob-content');
        const themeToggleBtn = document.getElementById('theme-toggle-btn');

        // --- VIEW & STATE MANAGEMENT ---
        const switchView = (viewName) => {
            appState.currentView = viewName;
            
            if (viewName !== 'performer' && appState.simulationInterval) {
                clearInterval(appState.simulationInterval);
                appState.simulationInterval = null;
            }

            const currentTheme = body.classList.contains('theme-dark') ? 'theme-dark' : 'theme-light';
            body.className = currentTheme;
            if (viewName === 'performer') {
                body.classList.add('theme-dark');
            } else {
                body.classList.add('theme-light');
            }
            
            [plannerView, performerView, analyzerView, logisticsView, commercialView, hseView, pobView].forEach(v => v.classList.add('hidden'));
            headerDetails.innerHTML = '';
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            
            const activeLink = document.getElementById(`${viewName}-nav-link`);
            if(activeLink) activeLink.classList.add('active');

            document.getElementById(`${viewName}-view`).classList.remove('hidden');
            
            let viewTitle = viewName.charAt(0).toUpperCase() + viewName.slice(1);
            if(viewName === 'pob') viewTitle = 'POB & ER';
            if(viewName === 'hse') viewTitle = 'HSE & Risk';
            headerTitle.textContent = `WellTegra: ${viewTitle}`;

            if (viewName === 'performer') {
                body.className = 'theme-dark';
                if (appState.selectedWell && appState.generatedPlan) {
                     // FIX: If a plan exists but liveData is null (e.g., returning after reset), re-initialize.
                     if (!appState.liveData) {
                         initializePerformer();
                     }
                     headerDetails.innerHTML = `<span id="job-status" class="text-lg font-semibold text-emerald-400 animate-pulse">‚óè LIVE</span><div class="text-right"><p class="text-sm text-slate-300">Well: ${appState.selectedWell.name}</p><p class="text-sm text-slate-300">Job: ${appState.generatedPlan.name}</p></div>`;
                    if(!appState.simulationInterval) {
                        startSimulation();
                    }
                } else {
                    performerView.innerHTML = `<div class="flex items-center justify-center h-full text-center"><div class="bg-slate-800 p-10 rounded-lg shadow-2xl"><h2 class="text-2xl font-bold mb-4">No Active Operation</h2><p class="text-slate-400 mb-6">Please go to the Planner to select a well and generate an intervention plan.</p><button id="go-to-planner-btn" class="bg-teal-600 hover:bg-teal-500 text-white font-bold py-2 px-4 rounded-md">Go to Planner</button></div></div>`;
                    document.getElementById('go-to-planner-btn').addEventListener('click', () => switchView('planner'));
                }
            } else if (['analyzer', 'commercial', 'hse'].includes(viewName)) {
                if(appState.selectedWell && appState.generatedPlan) {
                    headerDetails.innerHTML = `<div class="text-right"><p class="text-sm">Well: ${appState.selectedWell.name}</p><p class="text-sm">Job: ${appState.generatedPlan.name}</p></div>`;
                }
                if (viewName === 'commercial') initializeCommercial();
                if (viewName === 'hse') initializeHSE();
                if (viewName === 'analyzer') initializeAnalyzer();
            } else if (viewName === 'logistics' || viewName === 'pob') {
                renderAssetManagementViews();
            }
        };
        
        const resetApp = () => {
            if (appState.simulationInterval) {
                clearInterval(appState.simulationInterval);
                appState.simulationInterval = null;
            }
            appState.liveData = null;
            appState.selectedWell = null; 
            appState.selectedObjective = null; 
            appState.generatedPlan = null; 
            appState.lessonsLearned = [];
            appState.commercial = { afe: 0, actualCost: 0, serviceTickets: [] };
            appState.ai = { selectedProblemId: null, selectedRecommendation: null };
            document.querySelectorAll('.planner-card').forEach(c => c.classList.remove('selected'));
            if(document.querySelector('input[name="objective"]:checked')) { document.querySelector('input[name="objective"]:checked').checked = false; }
            if(document.querySelector('input[name="problem"]:checked')) { document.querySelector('input[name="problem"]:checked').checked = false; }
            generatePlanBtnManual.disabled = true;
            generatePlanBtnAi.disabled = true;
            aiRecommendationsContainer.classList.add('hidden');
            aiToggle.checked = false;
            manualPlanningView.classList.remove('hidden');
            aiAdvisorView.classList.add('hidden');
            switchView('planner');
            updatePlannerStepUI(1);
        };

        // --- PLANNER LOGIC ---
        const renderWellCards = () => { wellSelectionGrid.innerHTML = wellData.map(well => `<div class="planner-card light-card p-6 cursor-pointer" data-well-id="${well.id}"><div class="flex justify-between items-start"><div class="flex-1"><h3 class="text-xl font-bold">${well.name}</h3><p class="text-sm font-medium text-teal-600">${well.field} - ${well.type}</p></div><button class="view-details-btn text-sm text-teal-600 hover:text-teal-800 font-semibold" data-well-id="${well.id}">View Details</button></div><div class="mt-4 space-y-2 text-sm"><p><strong>Status:</strong> <span class="font-normal">${well.status}</span></p><p><strong>Issue:</strong> <span class="font-normal">${well.issue}</span></p></div></div>`).join(''); };
        const renderObjectives = () => { objectivesFieldset.innerHTML = objectivesData.map(obj => `<div><input type="radio" name="objective" id="${obj.id}" value="${obj.id}" class="sr-only"><label for="${obj.id}" class="objective-label flex flex-col p-4 rounded-lg border cursor-pointer"><span class="font-semibold">${obj.name}</span><span class="text-sm">${obj.description}</span></label></div>`).join(''); };
        const renderProblems = () => { problemsFieldset.innerHTML = problemsData.map(prob => `<div><input type="radio" name="problem" id="${prob.id}" value="${prob.id}" class="sr-only"><label for="${prob.id}" class="problem-label flex flex-col p-4 rounded-lg border cursor-pointer"><span class="font-semibold">${prob.name}</span><span class="text-sm">${prob.description}</span></label></div>`).join(''); };
        const renderPlan = () => {
            const well = appState.selectedWell, procedure = appState.generatedPlan, riskLabels = ['Operational', 'Geological', 'Equipment', 'HSE', 'Financial'], riskData = Object.values(procedure.risks);
            const getRiskTag = (level) => { if (level <= 2) return `<span class="risk-low px-2 py-1 text-xs font-medium rounded-full">Low</span>`; if (level <= 3) return `<span class="risk-medium px-2 py-1 text-xs font-medium rounded-full">Medium</span>`; return `<span class="risk-high px-2 py-1 text-xs font-medium rounded-full">High</span>`; };
            const logisticsConflicts = checkLogistics();
            let logisticsHtml = logisticsConflicts.length > 0 ? `<div><h4 class="text-xl font-semibold mb-4">Logistics & Resource Conflicts</h4><ul class="space-y-2">${logisticsConflicts.map(c => `<li class="flex items-start p-3 rounded-md bg-red-50 border-l-4 border-red-400"><span class="text-red-600 mr-2 font-bold">‚ö†Ô∏è</span><span class="text-red-800">${c}</span></li>`).join('')}</ul></div>` : '';
            planOutput.innerHTML = `<div><h3 class="text-2xl font-bold">Intervention Plan: ${well.name}</h3><p class="text-lg font-medium text-teal-700">${appState.selectedObjective.name}</p></div><div class="grid md:grid-cols-3 gap-6 text-center"><div class="bg-gray-50 p-4 rounded-lg"><p class="text-sm font-medium">Selected Well</p><p class="text-lg font-semibold">${well.name}</p></div><div class="bg-gray-50 p-4 rounded-lg"><p class="text-sm font-medium">Est. Duration</p><p class="text-lg font-semibold">${procedure.duration} days</p></div><div class="bg-gray-50 p-4 rounded-lg"><p class="text-sm font-medium">Est. Cost (AFE)</p><p class="text-lg font-semibold">$${procedure.cost.toLocaleString()}</p></div></div>${logisticsHtml}<div><h4 class="text-xl font-semibold mb-4">Baseline Procedure: ${procedure.name}</h4><ol class="list-decimal list-inside space-y-2">${procedure.steps.map(step => `<li>${step}</li>`).join('')}</ol></div><div><h4 class="text-xl font-semibold mb-4">Required Tooling & Equipment</h4><ul class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2">${procedure.tooling.map(tool => `<li class="flex items-center"><span class="text-teal-500 mr-2">&#10003;</span>${tool}</li>`).join('')}</ul></div><div><h4 class="text-xl font-semibold mb-4">Initial Risk Assessment</h4><div class="grid md:grid-cols-2 gap-8 items-center"><div class="space-y-3">${riskLabels.map((label, i) => `<div class="flex justify-between items-center bg-gray-50 p-2 rounded"><span class="font-medium">${label}</span>${getRiskTag(riskData[i])}</div>`).join('')}</div><div class="h-64 md:h-80"><canvas id="riskChart"></canvas></div></div></div>`;
            const riskChartCtx = document.getElementById('riskChart').getContext('2d');
            new Chart(riskChartCtx, { type: 'radar', data: { labels: riskLabels, datasets: [{ label: 'Risk Level', data: riskData, backgroundColor: 'rgba(13, 148, 136, 0.2)', borderColor: 'rgba(13, 148, 136, 1)', borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { r: { suggestedMin: 0, suggestedMax: 5, ticks: { stepSize: 1, display: false }, grid: { color: '#e5e7eb' }, angleLines: { color: '#e5e7eb' }, pointLabels: { color: '#374151' } } }, plugins: { legend: { display: false } } } });
        };
        const updatePlannerStepUI = (currentStep) => { Object.values(stepIndicators).forEach(ind => ind.classList.remove('active', 'completed')); for (let i = 1; i < currentStep; i++) { stepIndicators[i].classList.add('completed'); } stepIndicators[currentStep].classList.add('active'); step1Section.classList.toggle('hidden', currentStep !== 1); step2Section.classList.toggle('hidden', currentStep !== 2); step3Section.classList.toggle('hidden', currentStep !== 3); };

        // --- PERFORMER LOGIC ---
        const initializePerformer = () => {
            if (!document.getElementById('dashboard-grid')) {
                performerView.innerHTML = `
                <div class="h-full dashboard-grid" id="dashboard-grid">
                    <div id="procedure-panel" class="bg-slate-800/50 rounded-lg p-4 flex flex-col"><h2 class="text-lg font-semibold mb-4 border-b border-slate-700 pb-2">Operational Procedure</h2><div id="procedure-steps" class="flex-1 space-y-3 overflow-y-auto pr-2"></div><div id="performer-controls" class="hidden mt-4"><button id="view-analysis-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-md transition-transform duration-200 hover:scale-105">View Post-Job Analysis</button></div></div>
                    <div class="flex flex-col gap-4 lg:gap-6">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 lg:gap-6">
                            <div class="kpi-card p-4"><p class="text-sm text-slate-400">Hookload (klbf)</p><p id="kpi-hookload" class="text-3xl font-bold">0.0</p></div>
                            <div class="kpi-card p-4"><p class="text-sm text-slate-400">Pump Pressure (psi)</p><p id="kpi-pressure" class="text-3xl font-bold">0</p></div>
                            <div class="kpi-card p-4"><p class="text-sm text-slate-400">CT Speed (ft/min)</p><p id="kpi-speed" class="text-3xl font-bold">0</p></div>
                            <div class="kpi-card p-4"><p class="text-sm text-slate-400">Depth (ft)</p><p id="kpi-depth" class="text-3xl font-bold">0</p></div>
                        </div>
                        <div id="chart-card" class="flex-1 bg-slate-800/50 rounded-lg p-4 flex flex-col"><h3 class="text-lg font-semibold mb-2">Tubing Force Analysis: Plan vs. Actual</h3><div class="flex-1 relative"><canvas id="tfaChart"></canvas></div></div>
                        <div id="manual-controls" class="bg-slate-800/50 rounded-lg p-4 flex items-center justify-center space-x-4">
                            <button id="step-backward-btn" class="rounded-md bg-slate-600 px-6 py-2 text-base font-semibold text-white shadow-sm hover:bg-slate-500 disabled:opacity-50" disabled>Step Back</button>
                            <button id="step-forward-btn" class="rounded-md bg-teal-600 px-6 py-2 text-base font-semibold text-white shadow-sm hover:bg-teal-500">Step Forward</button>
                        </div>
                    </div>
                    <div class="bg-slate-800/50 rounded-lg p-4 flex flex-col"><h2 class="text-lg font-semibold mb-4 border-b border-slate-700 pb-2">Operations Log</h2><div id="log-entries" class="flex-1 space-y-3 overflow-y-auto mb-4 pr-2"></div><div class="mt-auto"><textarea id="log-input" class="w-full bg-slate-900 border border-slate-600 rounded-md p-2 text-sm" rows="3" placeholder="Add log entry..."></textarea><button id="add-log-btn" class="mt-2 w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2 px-4 rounded-md transition-transform duration-200 hover:scale-105">Add Entry</button></div></div>
                </div>`;
                document.getElementById('add-log-btn').addEventListener('click', () => { addLogEntry('Operator', document.getElementById('log-input').value); document.getElementById('log-input').value = ''; });
                document.getElementById('view-analysis-btn').addEventListener('click', () => { switchView('analyzer'); });
                document.getElementById('step-forward-btn').addEventListener('click', () => manualStep(true));
                document.getElementById('step-backward-btn').addEventListener('click', () => manualStep(false));
            }

            appState.liveData = { depth: 0, hookload: 0, pressure: 0, speed: 0, currentStep: 1, isRIH: true, jobRunning: true, alarmState: false, npt: { weather: 0, equipment: 0, operational: 0 }, opTime: 0 };
            appState.logEntries = [{ time: new Date(), user: 'System', text: 'Job initiated.' }];
            appState.generatedPlan.procedure = appState.generatedPlan.steps.map((s, i) => ({ id: i + 1, text: s, completed: false }));
            
            if (appState.tfaChartInstance) appState.tfaChartInstance.destroy();
            const chartCtx = document.getElementById('tfaChart').getContext('2d');
            const chartThemeOptions = getChartThemeOptions();
            appState.tfaChartInstance = new Chart(chartCtx, { type: 'line', data: { datasets: [ { label: 'Planned Pick-up', data: appState.generatedPlan.tfaModel.pickUp.map(p => ({x: p[0], y: p[1]})), borderColor: 'rgba(52, 211, 153, 0.8)', borderWidth: 2, pointRadius: 0, tension: 0.1 }, { label: 'Planned Slack-off', data: appState.generatedPlan.tfaModel.slackOff.map(p => ({x: p[0], y: p[1]})), borderColor: 'rgba(96, 165, 250, 0.8)', borderWidth: 2, pointRadius: 0, tension: 0.1 }, { label: 'Upper Alarm', data: appState.generatedPlan.tfaModel.alarmUpper.map(p => ({x: p[0], y: p[1]})), borderColor: 'rgba(239, 68, 68, 0.4)', borderWidth: 1, pointRadius: 0, borderDash: [5, 5], fill: '+1', tension: 0.1 }, { label: 'Lower Alarm', data: appState.generatedPlan.tfaModel.alarmLower.map(p => ({x: p[0], y: p[1]})), borderColor: 'rgba(239, 68, 68, 0.4)', borderWidth: 1, pointRadius: 0, borderDash: [5, 5], backgroundColor: 'rgba(239, 68, 68, 0.1)', fill: '-1', tension: 0.1 }, { label: 'Actual Hookload', data: [], borderColor: '#f59e0b', borderWidth: 3, pointRadius: 0, tension: 0.1 } ] }, options: { responsive: true, maintainAspectRatio: false, ...chartThemeOptions } });
            
            renderPerformerProcedure(); 
            renderPerformerLog();
            updatePerformerState(0);
            document.getElementById('performer-controls').classList.add('hidden');
        };

        const startSimulation = () => {
            if (appState.simulationInterval) clearInterval(appState.simulationInterval);
            appState.simulationInterval = setInterval(() => {
                // FIX: Defensive check to prevent crash if state is reset while interval is pending.
                if (!appState.liveData || !appState.liveData.jobRunning) {
                    clearInterval(appState.simulationInterval);
                    appState.simulationInterval = null;
                    return;
                }
                const currentStepText = appState.generatedPlan.procedure.find(s => s.id === appState.liveData.currentStep).text.toLowerCase();
                if (currentStepText.includes('rih') || currentStepText.includes('pooh')) {
                    const direction = currentStepText.includes('rih') ? 1 : -1;
                    const newDepth = appState.liveData.depth + (100 * direction);
                    updatePerformerState(newDepth);
                }
            }, 500);
        };

        const updatePerformerState = (newDepth) => {
            if (!appState.liveData || !appState.liveData.jobRunning) return;
            
            const targetDepth = 9500;
            appState.liveData.depth = Math.max(0, Math.min(targetDepth, newDepth));
            
            const stepText = appState.generatedPlan.procedure.find(s => s.id === appState.liveData.currentStep).text.toLowerCase();
            appState.liveData.isRIH = stepText.includes('rih') || stepText.includes('run in hole');
            appState.liveData.speed = (stepText.includes('rih') || stepText.includes('pooh')) ? (appState.liveData.isRIH ? 100 : -100) : 0;
            
            const modelPoints = appState.liveData.isRIH ? appState.generatedPlan.tfaModel.slackOff : appState.generatedPlan.tfaModel.pickUp;
            appState.liveData.hookload = interpolate(modelPoints, appState.liveData.depth) + (Math.random() - 0.5);
            
            if(appState.liveData.depth > 6000 && appState.liveData.depth < 7000 && appState.liveData.isRIH) { appState.liveData.hookload -= 5; appState.liveData.npt.operational += 0.005; }
            
            const upperLimit = interpolate(appState.generatedPlan.tfaModel.alarmUpper, appState.liveData.depth);
            const lowerLimit = interpolate(appState.generatedPlan.tfaModel.alarmLower, appState.liveData.depth);
            
            const chartCard = document.getElementById('chart-card');
            if (appState.liveData.hookload > upperLimit || appState.liveData.hookload < lowerLimit) { 
                if (!appState.liveData.alarmState) { 
                    addLogEntry('System', 'ALARM: Hookload outside envelope!'); 
                    appState.liveData.alarmState = true; 
                    if(chartCard) chartCard.classList.add('alarm'); 
                    appState.liveData.npt.equipment += 0.01; 
                } 
            } else { 
                if (appState.liveData.alarmState) { 
                    addLogEntry('System', 'INFO: Hookload back in envelope.'); 
                    appState.liveData.alarmState = false; 
                    if(chartCard) chartCard.classList.remove('alarm'); 
                } 
            }
            
            document.getElementById('kpi-hookload').textContent = appState.liveData.hookload.toFixed(1); 
            document.getElementById('kpi-pressure').textContent = Math.round(appState.liveData.pressure); 
            document.getElementById('kpi-speed').textContent = appState.liveData.speed; 
            document.getElementById('kpi-depth').textContent = Math.round(appState.liveData.depth);
            
            const actualData = appState.tfaChartInstance.data.datasets[4].data;
            actualData.push({ x: appState.liveData.depth, y: appState.liveData.hookload });
            actualData.sort((a, b) => a.x - b.x);
            appState.tfaChartInstance.update('none');

            if (appState.liveData.isRIH && appState.liveData.depth >= targetDepth) { advancePerformerStep(); }
            else if (!appState.liveData.isRIH && appState.liveData.depth <= 0 && stepText.includes('pooh')) { advancePerformerStep(); }
        };

        const renderPerformerProcedure = () => { 
            const container = document.getElementById('procedure-steps');
            if (!container || !appState.generatedPlan || !appState.liveData) return;
            container.innerHTML = appState.generatedPlan.procedure.map(step => `<div id="step-${step.id}" class="procedure-step p-3 rounded-md ${step.completed ? 'completed' : ''} ${appState.liveData.currentStep === step.id ? 'active' : ''}"><p class="font-semibold text-sm">${step.text}</p></div>`).join(''); 
        };
        const renderPerformerLog = () => { 
            const container = document.getElementById('log-entries');
            if (!container) return;
            container.innerHTML = appState.logEntries.slice().reverse().map(entry => `<div class="log-entry p-2"><p class="text-xs text-slate-400">${entry.time.toLocaleTimeString()} - ${entry.user}</p><p class="text-sm text-slate-200">${entry.text}</p></div>`).join(''); 
            container.scrollTop = 0; 
        };
        const addLogEntry = (user, text) => { if (!text.trim()) return; appState.logEntries.push({ time: new Date(), user, text }); renderPerformerLog(); };
        
        const advancePerformerStep = () => {
            const current = appState.generatedPlan.procedure.find(s => s.id === appState.liveData.currentStep); if (current) current.completed = true;
            if (appState.liveData.currentStep < appState.generatedPlan.procedure.length) {
                appState.liveData.currentStep++; const next = appState.generatedPlan.procedure.find(s => s.id === appState.liveData.currentStep); addLogEntry('System', `Step ${next.id}: ${next.text}`); appState.liveData.isRIH = next.text.toLowerCase().includes('rih');
            } else { 
                appState.liveData.jobRunning = false; 
                addLogEntry('System', 'Job procedure complete.'); 
                const jobStatusEl = document.getElementById('job-status');
                if (jobStatusEl) {
                    jobStatusEl.textContent = "‚óè JOB COMPLETE"; 
                    jobStatusEl.classList.remove('text-emerald-400', 'animate-pulse');
                    jobStatusEl.classList.add('text-gray-500');
                }
                const performerControls = document.getElementById('performer-controls');
                if(performerControls) performerControls.classList.remove('hidden'); 
            }
            renderPerformerProcedure();
        };

        const manualStep = (forward) => {
            if (!appState.liveData || !appState.liveData.jobRunning) return;
            const stepText = appState.generatedPlan.procedure.find(s => s.id === appState.liveData.currentStep).text.toLowerCase();
            if (stepText.includes('rih') || stepText.includes('pooh')) {
                const direction = forward ? 1 : -1;
                const newDepth = appState.liveData.depth + (250 * direction);
                updatePerformerState(newDepth);
            }
        };

        function interpolate(points, x) { for (let i = 0; i < points.length - 1; i++) { if (x >= points[i][0] && x <= points[i+1][0]) { return points[i][1] + (points[i+1][1] - points[i][1]) * (x - points[i][0]) / (points[i+1][0] - points[i][0]); } } return points[points.length - 1][1]; }

        // --- ANALYZER LOGIC ---
        const initializeAnalyzer = () => {
            if (!appState.generatedPlan || !appState.liveData) {
                analyzerView.innerHTML = `<p class="text-center">No completed job data available. Please run an operation in the Performer view first.</p>`;
                return;
            }
            analyzerSubtitle.textContent = `Analysis for ${appState.generatedPlan.name} on ${appState.selectedWell.name}`;
            const plannedDuration = appState.generatedPlan.duration;
            const actualDuration = plannedDuration + appState.liveData.npt.weather + appState.liveData.npt.equipment + appState.liveData.npt.operational;
            const plannedCost = appState.generatedPlan.cost;
            const actualCost = appState.commercial.actualCost || plannedCost * (1 + (actualDuration - plannedDuration)/plannedDuration * 0.5); // Simplified cost overrun
            const renderKPI = (label, plan, actual) => `<div class="bg-gray-50 p-4 rounded-lg"><p class="text-sm font-medium">"${label}"</p><p class="text-lg font-semibold">${actual} <span class="text-sm font-normal">(Plan: ${plan})</span></p></div>`;
            summaryKpis.innerHTML = renderKPI('Job Duration (Days)', plannedDuration.toFixed(1), actualDuration.toFixed(1)) + renderKPI('Total Cost (USD)', `$${plannedCost.toLocaleString()}`, `$${Math.round(actualCost).toLocaleString()}`);
            if (appState.nptChartInstance) appState.nptChartInstance.destroy();
            const nptCtx = document.getElementById('nptChart').getContext('2d');
            const chartThemeOptions = getChartThemeOptions();
            appState.nptChartInstance = new Chart(nptCtx, { type: 'doughnut', data: { labels: ['Weather', 'Equipment Failure', 'Operational Inefficiency'], datasets: [{ data: [appState.liveData.npt.weather, appState.liveData.npt.equipment, appState.liveData.npt.operational], backgroundColor: ['#3b82f6', '#f97316', '#ef4444'], borderColor: body.classList.contains('theme-dark') ? '#1f2937' : '#F8F7F4', borderWidth: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: chartThemeOptions.plugins.legend.labels.color } } } } });
            renderLessons();
        };
        const renderLessons = () => { lessonsLearnedList.innerHTML = appState.lessonsLearned.length ? appState.lessonsLearned.map(lesson => `<div class="bg-gray-100 p-3 rounded-md"><p>${lesson}</p></div>`).join('') : `<p class="text-center text-gray-500">No lessons learned have been added for this job.</p>`; };
        
        // --- ASSET MANAGEMENT LOGIC ---
        const renderAssetManagementViews = (eqFilter = '', persFilter = '') => {
            const eqF = eqFilter.toLowerCase();
            equipmentTableBody.innerHTML = equipmentData.filter(e => e.id.toLowerCase().includes(eqF) || e.type.toLowerCase().includes(eqF)).map(e => `<tr><td class="p-2">${e.id}</td><td class="p-2">${e.type}</td><td class="p-2">${e.location}</td><td class="p-2"><span class="px-2 py-1 text-xs font-medium rounded-full status-${e.testStatus.toLowerCase()}">${e.testStatus}</span></td><td class="p-2"><button class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full hover:bg-blue-200 disabled:opacity-50" ${e.location === 'Onboard - Pump Room' && e.testStatus === 'Pending' ? '' : 'disabled'}>Test</button></td></tr>`).join('');
            const persF = persFilter.toLowerCase();
            personnelTableBody.innerHTML = personnelData.filter(p => p.name.toLowerCase().includes(persF) || p.role.toLowerCase().includes(persF)).map(p => `<tr><td class="p-2">${p.name}</td><td class="p-2">${p.role}</td><td class="p-2"><span class="px-2 py-1 text-xs font-medium rounded-full status-${p.status.toLowerCase().replace(' ','.')}">${p.status}</span></td><td class="p-2">${p.certsValid ? '‚úÖ Valid' : '‚ùå Expired'}</td></tr>`).join('');
            initializePOB();
        };
        const checkLogistics = () => {
            const conflicts = [];
            appState.generatedPlan.tooling.forEach(toolName => { const availableTool = equipmentData.find(e => e.type === toolName && e.status === 'Available'); if (!availableTool) { conflicts.push(`No available equipment of type: <strong>${toolName}</strong>.`); } else if (new Date(availableTool.nextMaint) < new Date()) { conflicts.push(`Equipment <strong>${availableTool.id} (${toolName})</strong> is overdue for maintenance.`); } });
            appState.generatedPlan.personnel.forEach(roleName => { const availablePerson = personnelData.find(p => p.role === roleName && p.status === 'Available'); if (!availablePerson) { conflicts.push(`No available personnel for role: <strong>${roleName}</strong>.`); } else if (!availablePerson.certsValid) { conflicts.push(`Personnel <strong>${availablePerson.name} (${roleName})</strong> has expired certifications.`); } });
            return conflicts;
        };

        // --- COMMERCIAL LOGIC ---
        const initializeCommercial = () => {
            if (!appState.generatedPlan) {
                commercialContent.innerHTML = `<p class="text-center">Please generate a plan in the Planner module first to view commercial data.</p>`;
                return;
            }
            commercialSubtitle.textContent = `Live financial tracking for ${appState.generatedPlan.name} on ${appState.selectedWell.name}`;
            appState.commercial.afe = appState.generatedPlan.cost;
            appState.commercial.actualCost = 0;
            appState.commercial.serviceTickets = [];
            
            appState.generatedPlan.tooling.forEach(toolName => {
                const tool = equipmentData.find(t => t.type === toolName);
                if(tool) {
                    const cost = tool.rate * 0.25; // Mobilization cost
                    appState.commercial.serviceTickets.push({ description: `Mobilization: ${tool.type} (${tool.id})`, cost: cost, validated: true });
                    appState.commercial.actualCost += cost;
                }
            });
            renderCommercialView();
        };
        const renderCommercialView = () => {
            const afe = appState.commercial.afe;
            const actual = appState.commercial.actualCost;
            const burnPercent = afe > 0 ? Math.min(100, (actual / afe) * 100) : 0;
            const burnColor = burnPercent > 90 ? 'bg-red-500' : burnPercent > 75 ? 'bg-yellow-500' : 'bg-teal-500';

            commercialContent.innerHTML = `
                <div class="grid gap-8 lg:grid-cols-3">
                    <div class="lg:col-span-2 light-card p-6">
                        <h3 class="text-xl font-semibold mb-4">Live AFE vs. Actual</h3>
                        <div class="space-y-4">
                            <div class="flex justify-between font-bold text-lg"><span>Actual Cost</span><span>$${actual.toLocaleString()}</span></div>
                            <div class="w-full bg-gray-200 rounded-full h-4"><div class="${burnColor} h-4 rounded-full" style="width: ${burnPercent}%"></div></div>
                            <div class="flex justify-between text-sm"><span>Budget (AFE): $${afe.toLocaleString()}</span><span>${burnPercent.toFixed(1)}% Used</span></div>
                        </div>
                        <h3 class="text-xl font-semibold mt-8 mb-4">Automated Service Tickets</h3>
                        <div class="h-64 overflow-y-auto border rounded-md">
                            <table class="w-full text-sm text-left"><thead class="table-header"><tr><th class="p-2">Description</th><th>Cost</th><th>Status</th></tr></thead>
                            <tbody id="service-ticket-body">${appState.commercial.serviceTickets.map(t => `<tr class="border-b table-row-alt"><td class="p-2">${t.description}</td><td class="p-2">$${t.cost.toLocaleString()}</td><td class="p-2"><span class="status-available px-2 py-1 text-xs font-medium rounded-full">Validated</span></td></tr>`).join('')}</tbody>
                            </table>
                        </div>
                    </div>
                    <div class="light-card p-6">
                        <h3 class="text-xl font-semibold mb-4">Invoice Validation</h3>
                        <p class="text-sm mb-4">Enter a service company invoice amount to check it against validated, system-generated costs.</p>
                        <div class="space-y-2">
                            <label for="invoice-amount" class="text-sm font-medium">Invoice Amount (USD)</label>
                            <input type="number" id="invoice-amount" class="w-full p-2 border border-gray-300 rounded-md" placeholder="e.g., 850000">
                        </div>
                        <button id="validate-invoice-btn" class="mt-4 w-full rounded-md bg-blue-600 px-4 py-2 text-base font-semibold text-white shadow-sm hover:bg-blue-500">Validate Invoice</button>
                        <div id="invoice-result" class="mt-4"></div>
                    </div>
                </div>`;
                document.getElementById('validate-invoice-btn').addEventListener('click', validateInvoice);
        };
        const validateInvoice = () => {
            const invoiceAmount = parseFloat(document.getElementById('invoice-amount').value);
            const validatedCost = appState.commercial.actualCost;
            const resultContainer = document.getElementById('invoice-result');
            if(isNaN(invoiceAmount)) {
                resultContainer.innerHTML = `<div class="p-3 rounded-md bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800">Please enter a valid amount.</div>`;
                return;
            }
            const difference = invoiceAmount - validatedCost;
            if (Math.abs(difference) < 0.01) {
                resultContainer.innerHTML = `<div class="p-3 rounded-md bg-green-50 border-l-4 border-green-400 text-green-800"><strong>Match!</strong> Invoice amount of $${invoiceAmount.toLocaleString()} matches validated system cost.</div>`;
            } else {
                resultContainer.innerHTML = `<div class="p-3 rounded-md bg-red-50 border-l-4 border-red-400 text-red-800"><strong>Discrepancy Found!</strong> Invoice is <strong>$${Math.abs(difference).toLocaleString()} ${difference > 0 ? 'over' : 'under'}</strong> system-validated cost.</div>`;
            }
        };

        // --- AI ADVISOR LOGIC ---
        aiToggle.addEventListener('change', (e) => {
            const isAiMode = e.target.checked;
            manualPlanningView.classList.toggle('hidden', isAiMode);
            aiAdvisorView.classList.toggle('hidden', !isAiMode);
        });
        problemsFieldset.addEventListener('change', (e) => {
            appState.ai.selectedProblemId = e.target.value;
            const recommendations = aiRecommendations[appState.ai.selectedProblemId] || [];
            aiRecommendationsContainer.innerHTML = `<h3 class="text-lg font-semibold text-center mb-4 mt-6">AI Recommendations</h3><div class="space-y-4">${recommendations.map((rec, i) => {
                const objective = objectivesData.find(o => o.id === rec.objectiveId);
                return `<div class="ai-recommendation-card p-4 rounded-lg" data-rec-index="${i}">
                            <div class="flex justify-between items-start">
                                <h4 class="font-bold text-lg text-teal-700">${objective.name}</h4>
                                <span class="text-sm font-medium">${rec.confidence}% Confidence</span>
                            </div>
                            <p class="text-sm mt-1"><strong>Projected Outcome:</strong> ${rec.outcome}</p>
                            <p class="text-xs mt-2"><strong>Reasoning:</strong> ${rec.reason}</p>
                        </div>`;
            }).join('')}</div>`;
            aiRecommendationsContainer.classList.remove('hidden');
            document.querySelectorAll('.ai-recommendation-card').forEach(card => card.addEventListener('click', selectAiRecommendation));
        });
        const selectAiRecommendation = (e) => {
            const card = e.target.closest('.ai-recommendation-card');
            const recIndex = parseInt(card.dataset.recIndex);
            appState.ai.selectedRecommendation = aiRecommendations[appState.ai.selectedProblemId][recIndex];
            document.querySelectorAll('.ai-recommendation-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            generatePlanBtnAi.disabled = false;
        };
        
        // --- MODAL LOGIC ---
        const openModal = (wellId) => {
            const well = wellData.find(w => w.id === wellId);
            if (!well) return;
            modalTitle.textContent = `Well History & Schematic: ${well.name}`;
            
            modalContent.innerHTML = `
                <div class="mb-4 border-b">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <a href="#" class="modal-tab active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="history">Operational History & Schematic</a>
                        <a href="#" class="modal-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="reports">Historical Daily Reports</a>
                    </nav>
                </div>
                <div id="modal-tab-history">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-2"><h4 class="text-xl font-semibold mb-4">Operational History</h4><div id="history-content"></div></div>
                        <div class="md:col-span-1"><h4 class="text-xl font-semibold mb-4">Live Wellbore Schematic</h4><div class="bg-white p-2 rounded-lg shadow-inner border">${renderWellSchematic(well)}</div></div>
                    </div>
                </div>
                <div id="modal-tab-reports" class="hidden">
                    <h4 class="text-xl font-semibold mb-4">Daily Reports (from legacy spreadsheets)</h4>
                    <div id="reports-content" class="h-96 overflow-y-auto"></div>
                </div>
            `;
            
            renderModalTabs(well);

            document.querySelectorAll('.modal-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
                    e.target.classList.add('active');
                    document.getElementById('modal-tab-history').classList.add('hidden');
                    document.getElementById('modal-tab-reports').classList.add('hidden');
                    document.getElementById(`modal-tab-${e.target.dataset.tab}`).classList.remove('hidden');
                });
            });

            modal.classList.remove('hidden');
        };
        const renderModalTabs = (well) => {
             document.getElementById('history-content').innerHTML = well.history.length ? well.history.map(h => `
                <div class="p-4 mb-4 border rounded-lg bg-gray-50">
                    <p class="font-bold text-lg">${h.operation} <span class="text-sm font-normal">- ${h.date}</span></p>
                    <div class="mt-2 pl-4 border-l-2 border-gray-200">
                        <p class="text-sm"><strong class="text-red-600">Problem:</strong> ${h.problem}</p>
                        <p class="text-sm mt-1"><strong class="text-green-600">Lesson Learned:</strong> ${h.lesson}</p>
                    </div>
                </div>
            `).join('') : '<p>No historical data available for this well.</p>';
            
            document.getElementById('reports-content').innerHTML = well.dailyReports.length ? `<table class="w-full text-sm text-left"><thead class="table-header"><tr><th class="p-2">Date</th><th class="p-2">Summary</th><th class="p-2">NPT (hrs)</th></tr></thead><tbody>
                ${well.dailyReports.map(r => `<tr class="border-b table-row-alt"><td class="p-2">${r.date}</td><td class="p-2">${r.summary}</td><td class="p-2">${r.npt}</td></tr>`).join('')}
            </tbody></table>` : '<p>No daily reports available for this well.</p>';
        };
        const closeModal = () => modal.classList.add('hidden');
        const renderWellSchematic = (well) => {
            let svgContent = `<svg viewBox="0 0 150 600" class="w-full h-auto"><g class="schematic-depth-marker" text-anchor="end"><text x="25" y="53">0m</text><line x1="28" y1="50" x2="35" y2="50" stroke="#d1d5db" stroke-width="1"/><text x="25" y="153">1000m</text><line x1="28" y1="150" x2="35" y2="150" stroke="#d1d5db" stroke-width="1"/><text x="25" y="253">2000m</text><line x1="28" y1="250" x2="35" y2="250" stroke="#d1d5db" stroke-width="1"/><text x="25" y="353">3000m</text><line x1="28" y1="350" x2="35" y2="350" stroke="#d1d5db" stroke-width="1"/></g><rect x="40" y="0" width="100" height="600" fill="#eaddc7" /><rect x="50" y="0" width="80" height="600" fill="#d2b48c" /><rect x="50" y="20" width="80" height="10" fill="#9ca3af"/><rect x="75" y="10" width="30" height="10" fill="#6b7280"/>`;
            well.completion.casing?.forEach(c => { const topY = (c.top / 4000) * 600; const height = ((c.bottom - c.top) / 4000) * 600; svgContent += `<rect x="60" y="${topY}" width="60" height="${height}" fill="none" stroke="${c.isProblem ? '#ef4444' : '#6b7280'}" stroke-width="2"/>`; });
            well.completion.tubing?.forEach(t => { const topY = (t.top / 4000) * 600; const height = ((t.bottom - t.top) / 4000) * 600; svgContent += `<rect x="85" y="${topY}" width="10" height="${height}" fill="#d1d5db" stroke="#9ca3af" stroke-width="0.5"/>`; });
            well.completion.equipment?.forEach(e => { const y = (e.top / 4000) * 600; if(e.item.includes('Packer')) { svgContent += `<polygon points="75,${y-10} 105,${y-10} 110,${y} 70,${y}" fill="#4b5563"/>`; } else if (e.item.includes('SSSV')) { svgContent += `<rect x="82" y="${y}" width="16" height="20" class="${e.isProblem ? 'stroke-red-500 fill-red-200/50' : 'fill-gray-400'}" stroke-width="1"/><path d="M 85 ${y+3} l 10 14 M 85 ${y+17} l 10 -14" stroke="${e.isProblem ? '#ef4444' : '#6b7280'}" stroke-width="1.5"/>`; } else if (e.item.includes('Scale')) { svgContent += `<path d="M 85 ${y-10} C 80 ${y}, 80 ${y+10}, 85 ${y+20}" stroke="#c2410c" stroke-width="2" fill="none" stroke-linecap="round"/><path d="M 95 ${y-10} C 100 ${y}, 100 ${y+10}, 95 ${y+20}" stroke="#c2410c" stroke-width="2" fill="none" stroke-linecap="round"/>`; } });
            well.completion.perforations?.forEach(p => { const topY = (p.top / 4000) * 600; const bottomY = (p.bottom / 4000) * 600; for(let y = topY; y <= bottomY; y += 10) { svgContent += `<path d="M 60 ${y} L 40 ${y}" stroke="${p.isProblem ? '#ef4444' : '#1d4ed8'}" stroke-width="1.5" />`; if(p.isProblem) svgContent += `<path d="M 40 ${y} l 4 4 m -4 0 l 4 -4" stroke="#ef4444" stroke-width="1.5"/>`; } });
            well.completion.plugs?.forEach(p => { const topY = (p.top / 4000) * 600; const height = ((p.bottom - p.top) / 4000) * 600; svgContent += `<rect x="55" y="${topY}" width="70" height="${height}" fill="#a8a29e"/>`; });
            svgContent += `</svg>`; return svgContent;
        };

        // --- HSE & RISK LOGIC ---
        const initializeHSE = () => {
             if (!appState.generatedPlan) { hseContent.innerHTML = `<p class="text-center">Please generate a plan in the Planner module first to view job-specific HSE & Risk data.</p>`; return; }
            hseSubtitle.textContent = `Risk register and permits for ${appState.generatedPlan.name} on ${appState.selectedWell.name}`;
            appState.hse.permits = [ { id: 'PTW001', name: 'General Permit to Work', status: 'Approved' }, { id: 'PTW002', name: 'Hot Work Permit', status: 'Pending' }, { id: 'PTW003', name: 'Confined Space Entry', status: 'Approved' }, ];
            appState.hse.riskRegister = [ { hazard: 'Dropped Objects during Rig Up', consequence: 'Personnel Injury', mitigation: 'Establish exclusion zones; secure all items aloft.', risk: 'Medium' }, { hazard: 'Loss of Containment', consequence: 'Environmental Spill', mitigation: 'Verify PCE integrity; function test all valves.', risk: 'High' } ];
            renderHSEView();
        };
        const renderHSEView = () => {
            const riskRegisterHtml = `<div class="light-card p-6"><h3 class="text-xl font-semibold mb-4">Dynamic Risk Register</h3><div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="table-header"><tr><th class="p-2">Hazard</th><th class="p-2">Consequence</th><th class="p-2">Mitigation</th><th class="p-2">Risk Level</th></tr></thead><tbody>${appState.hse.riskRegister.map(r => `<tr class="border-b table-row-alt"><td class="p-2">${r.hazard}</td><td class="p-2">${r.consequence}</td><td class="p-2">${r.mitigation}</td><td class="p-2"><span class="risk-${r.risk.toLowerCase()} px-2 py-1 text-xs font-medium rounded-full">${r.risk}</span></td></tr>`).join('')}</tbody></table></div></div>`;
            const ptwHtml = `<div class="light-card p-6"><h3 class="text-xl font-semibold mb-4">Permit to Work (PTW) Status</h3><div class="space-y-3">${appState.hse.permits.map(p => `<div class="flex justify-between items-center bg-gray-50 p-3 rounded-md"><span class="font-medium">${p.name}</span><span class="px-2 py-1 text-xs font-medium rounded-full status-${p.status.toLowerCase()}">${p.status}</span></div>`).join('')}</div></div>`;
            hseContent.innerHTML = `<div class="grid gap-8 lg:grid-cols-2">${riskRegisterHtml}${ptwHtml}</div>`;
        };
        
        // --- POB & ER LOGIC ---
        const initializePOB = () => {
            appState.pob.personnel = JSON.parse(JSON.stringify(personnelData)).map(p => ({...p, musterStatus: 'Unaccounted'}));
            if(appState.pob.musterInterval) clearInterval(appState.pob.musterInterval);
            appState.pob.musterActive = false;
            renderPOBView();
        };
        const renderPOBView = () => {
            const totalPOB = appState.pob.personnel.length;
            const musteredCount = appState.pob.personnel.filter(p => p.musterStatus === 'Mustered').length;
            
            musterStations.forEach(ms => { ms.current = appState.pob.personnel.filter(p => p.muster === ms.id && p.musterStatus === 'Mustered').length; });

            const summaryHtml = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="light-card p-6 text-center"><p class="text-sm font-medium">Total Personnel on Board</p><p class="text-4xl font-bold">${totalPOB}</p></div>
                    <div class="light-card p-6 text-center"><p class="text-sm font-medium">Accounted For</p><p class="text-4xl font-bold text-green-600">${musteredCount}</p></div>
                    <div class="light-card p-6 text-center"><p class="text-sm font-medium">Unaccounted For</p><p class="text-4xl font-bold text-red-600">${totalPOB - musteredCount}</p></div>
                </div>`;

            const musterStationHtml = musterStations.map(ms => `
                <div class="light-card p-4"><h4 class="font-semibold">${ms.name}</h4><p class="text-sm">Capacity: ${ms.capacity}</p><p class="text-2xl font-bold">${ms.current}</p></div>`).join('');
            
            const pobTableHtml = `<div class="light-card p-6"><h3 class="text-xl font-semibold mb-4">Live POB Manifest</h3><div class="h-96 overflow-y-auto"><table class="w-full text-sm text-left"><thead class="table-header sticky top-0"><tr><th class="p-2">Name</th><th>Company</th><th>Role</th><th>Muster Station</th><th>Status</th></tr></thead><tbody>
                ${appState.pob.personnel.map(p => `<tr class="table-row-alt border-b"><td class="p-2">${p.name}</td><td class="p-2">${p.company}</td><td class="p-2">${p.role}</td><td class="p-2">${p.muster}</td><td class="p-2"><span class="px-2 py-1 text-xs font-medium rounded-full status-${p.musterStatus.toLowerCase().replace(' ', '')}">${p.musterStatus}</span></td></tr>`).join('')}
            </tbody></table></div></div>`;

            pobContent.innerHTML = `${summaryHtml}<div class="grid grid-cols-1 md:grid-cols-3 gap-8"><div class="md:col-span-2">${pobTableHtml}</div><div><div class="light-card p-6"><h3 class="text-xl font-semibold mb-4">Muster Stations</h3><div class="grid grid-cols-2 gap-4">${musterStationHtml}</div></div><div class="mt-8"><button id="muster-drill-btn" class="w-full rounded-md ${appState.pob.musterActive ? 'bg-red-600 hover:bg-red-500' : 'bg-yellow-500 hover:bg-yellow-400'} px-6 py-3 text-base font-semibold text-white shadow-sm">${appState.pob.musterActive ? 'End Muster Drill' : 'Simulate Emergency Muster'}</button></div></div></div>`;
            document.getElementById('muster-drill-btn').addEventListener('click', toggleMusterDrill);
        };
        const toggleMusterDrill = () => {
            appState.pob.musterActive = !appState.pob.musterActive;
            if (appState.pob.musterActive) {
                headerNav.classList.add('emergency-header');
                appState.pob.musterInterval = setInterval(() => {
                    const unaccounted = appState.pob.personnel.filter(p => p.musterStatus === 'Unaccounted');
                    if (unaccounted.length > 0) {
                        unaccounted[Math.floor(Math.random() * unaccounted.length)].musterStatus = 'Mustered';
                        renderPOBView();
                    } else {
                        clearInterval(appState.pob.musterInterval);
                        appState.pob.musterActive = false;
                        headerNav.classList.remove('emergency-header');
                    }
                }, 1000);
            } else {
                clearInterval(appState.pob.musterInterval);
                headerNav.classList.remove('emergency-header');
            }
            renderPOBView();
        };
        
        // --- THEME LOGIC ---
        const setTheme = (theme) => {
            // Performer view is always dark, so this logic mostly applies to other views
            if (appState.currentView !== 'performer') {
                body.className = `theme-${theme}`;
            }
            localStorage.setItem('theme', theme);
            
            // Update charts if they exist
            if (appState.tfaChartInstance) {
                appState.tfaChartInstance.options = { ...appState.tfaChartInstance.options, ...getChartThemeOptions() };
                appState.tfaChartInstance.update();
            }
            if (appState.nptChartInstance) {
                const chartTheme = getChartThemeOptions();
                appState.nptChartInstance.options.plugins.legend.labels.color = chartTheme.plugins.legend.labels.color;
                appState.nptChartInstance.data.datasets[0].borderColor = theme === 'dark' ? '#1f2937' : '#F8F7F4';
                appState.nptChartInstance.update();
            }
        };
        const getChartThemeOptions = () => {
            const isDark = body.classList.contains('theme-dark');
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : '#d1d5db';
            const textColor = isDark ? '#d1d5db' : '#4b5563';
            return {
                scales: { 
                    x: { grid: { color: gridColor }, ticks: { color: textColor }, title: { display: true, text: 'Depth (ft)', color: textColor } }, 
                    y: { grid: { color: gridColor }, ticks: { color: textColor }, title: { display: true, text: 'Hookload (klbf)', color: textColor } } 
                },
                plugins: { legend: { labels: { color: textColor } } }
            };
        };

        // --- EVENT LISTENERS ---
        themeToggleBtn.addEventListener('click', () => {
            const currentTheme = localStorage.getItem('theme') || 'light';
            setTheme(currentTheme === 'dark' ? 'light' : 'dark');
        });

        document.getElementById('performer-nav-link').addEventListener('click', () => switchView('performer'));
        document.getElementById('planner-nav-link').addEventListener('click', () => switchView('planner'));
        document.getElementById('logistics-nav-link').addEventListener('click', () => switchView('logistics'));
        document.getElementById('commercial-nav-link').addEventListener('click', () => switchView('commercial'));
        document.getElementById('hse-nav-link').addEventListener('click', () => switchView('hse'));
        document.getElementById('pob-nav-link').addEventListener('click', () => switchView('pob'));
        document.getElementById('analyzer-nav-link').addEventListener('click', () => switchView('analyzer'));

        wellSelectionGrid.addEventListener('click', (e) => {
            if (e.target.closest('.view-details-btn')) {
                e.stopPropagation();
                openModal(e.target.closest('.view-details-btn').dataset.wellId);
                return;
            }
            const card = e.target.closest('.planner-card');
            if (!card) return;
            appState.selectedWell = wellData.find(w => w.id === card.dataset.wellId);
            document.querySelectorAll('.planner-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            updatePlannerStepUI(2);
        });
        objectivesFieldset.addEventListener('change', (e) => { appState.selectedObjective = objectivesData.find(o => o.id === e.target.value); generatePlanBtnManual.disabled = !appState.selectedObjective; });
        generatePlanBtnManual.addEventListener('click', () => { if (!appState.selectedWell || !appState.selectedObjective) return; appState.generatedPlan = proceduresData[appState.selectedObjective.id]; renderPlan(); updatePlannerStepUI(3); });
        generatePlanBtnAi.addEventListener('click', () => { if (!appState.selectedWell || !appState.ai.selectedRecommendation) return; appState.selectedObjective = objectivesData.find(o => o.id === appState.ai.selectedRecommendation.objectiveId); appState.generatedPlan = proceduresData[appState.selectedObjective.id]; renderPlan(); updatePlannerStepUI(3); });
        startOverBtn.addEventListener('click', resetApp);
        beginOpBtn.addEventListener('click', () => { if (!appState.generatedPlan) return; initializePerformer(); switchView('performer'); });
        
        // Event listeners for performer view are added dynamically in initializePerformer
        
        addLessonBtn.addEventListener('click', () => { if(lessonInput.value.trim()){ appState.lessonsLearned.push(lessonInput.value.trim()); lessonInput.value = ''; renderLessons(); } });
        planNewJobBtn.addEventListener('click', resetApp);
        
        equipmentSearch.addEventListener('input', (e) => renderAssetManagementViews(e.target.value, personnelSearch.value));
        personnelSearch.addEventListener('input', (e) => renderAssetManagementViews(equipmentSearch.value, e.target.value));
        
        closeModalBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
        
        // --- INITIALIZATION ---
        renderWellCards();
        renderObjectives();
        renderProblems();
        
        // Default to a pre-selected plan for immediate live view
        appState.selectedWell = wellData[0];
        appState.selectedObjective = objectivesData[0];
        appState.generatedPlan = proceduresData[objectivesData[0].id];
        
        const savedTheme = localStorage.getItem('theme') || 'dark';
        setTheme(savedTheme);
        
        initializePerformer();
        switchView('performer');
    });
    </script>
</body>
</html>
https://x.com/i/grok/share/uf3lGUZLpjE3JCGyESMcbofMQ
